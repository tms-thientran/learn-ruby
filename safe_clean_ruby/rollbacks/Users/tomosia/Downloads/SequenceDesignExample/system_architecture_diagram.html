<!DOCTYPE html><html><head>
      <title>system_architecture_diagram</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/anh.le/.cursor/extensions/shd101wyy.markdown-preview-enhanced-0.8.19-universal/crossnote/dependencies/katex/katex.min.css">
      
      
      <script type="text/javascript" src="file:////Users/anh.le/.cursor/extensions/shd101wyy.markdown-preview-enhanced-0.8.19-universal/crossnote/dependencies/mermaid/mermaid.min.js" charset="UTF-8"></script>
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="functional-detail-design-document-system-architecture-diagram">[Functional Detail Design Document] System Architecture Diagram </h1>
<pre class="language-text">**Hệ thống:** 請求チェックWEBシステム月次審査チェック機能データベース定義書 
**版数:**	Ver 1.0.0  	
**作成日:**	2025年9月30日	
**最終更新日:**	2025年10月13日	
**作成者:**	Relipa株式会社
</pre>
<h2 id="1-tổng-quan-hệ-thống">1. Tổng quan hệ thống </h2>
<h3 id="11-tổng-quan-hệ-thống">1.1 Tổng quan hệ thống </h3>
<ul>
<li>Cung cấp chức năng check tự động dữ liệu quản lý phúc lợi(給付管理データ), dữ liệu file M.</li>
<li>Mục tiêu phát hành cuối cùng: Cuối tháng 10 năm 2025</li>
<li>Phương pháp phát triển: Phát triển toàn diện (Relipa)</li>
<li>Phạm vi bị loại trừ: Tích hợp API từ H2 Home (phát triển này bị loại trừ)</li>
<li>Triển khai trên môi trường AWS, sử dụng EC2, RDS, S3 và SES.</li>
</ul>
<h3 id="12-dự-kiến-sử-dụng">1.2 Dự kiến sử dụng </h3>
<p>■ Đối tượng áp dụng<br>
・Service Line chăm sóc cơ sở/chăm sóc người cao tuổi(訪問介護・訪問高住サービスライン)<br>
訪問介護ｻｰﾋﾞｽﾗｲﾝ, 訪問高住ｻｰﾋﾞｽﾗｲﾝ (2 department này sẽ có các cơ sở đk file M)<br>
・Service Line chăm sóc tại nhà (居宅支援ｻｰﾋﾞｽﾗｲﾝ): Các cơ sở này sẽ đk file K<br>
※Các Service Line khác dự kiến sẽ bổ sung trong tương lai.</p>
<p>■ Số lượng cơ sở áp dụng<br>
205 cơ sở (124 cơ sở dịch vụ/訪問, 81 cơ sở dịch vụ tại nhà/toàn diện/居宅・包括)<br>
※ Có trùng lặp.<br>
■Người dùng sử dụng, view<br>
Khoảng 300 người<br>
※Giả định khoảng 60% người dùng sử dụng đồng thời.<br>
■Thời gian sử dụng<br>
Từ ngày làm việc thứ 2 đến ngày làm việc thứ 5 hàng tháng</p>
<h2 id="2-kiến-trúc-tổng-thể-hệ-thống-system-architecture">2. Kiến trúc tổng thể hệ thống (System Architecture) </h2>
<h3 id="21-cấu-trúc-hệ-thống">2.1 Cấu trúc hệ thống </h3>
<p>Hệ thống được xây dựng bằng Framework Laravel 8 theo mô hình <strong>MVC (Model - View - Controller)</strong><br>
Các thành phần chính:</p>
<ul>
<li><strong>Web UI:</strong> Giao diện web cho người dùng thao tác.</li>
<li><strong>Controller:</strong> Tiếp nhận request, xử lý logic cơ bản và gọi service.</li>
<li><strong>Service:</strong> Thực hiện nghiệp vụ (Business Logic).</li>
<li><strong>Model:</strong> Giao tiếp với database.</li>
<li><strong>Database:</strong> Lưu trữ dữ liệu của hệ thống.</li>
<li><strong>ZOO Auth Service:</strong> Dịch vụ bên thứ ba dùng cho xác thực (login).</li>
<li><strong>Supervisor Service:</strong> Giám sát việc thực thi các tác vụ nền (queue jobs, schedule tasks) trong hệ thống.</li>
</ul>
<h3 id="22-cấu-trúc-layer">2.2 Cấu trúc layer </h3>
<h4 id="221-presentation-layer">2.2.1 Presentation Layer </h4>
<ul>
<li><strong>Web UI</strong>: Giao diện người dùng web được xây dựng bằng HTML, CSS và JavaScript</li>
</ul>
<h4 id="222-business-logic-layer">2.2.2 Business Logic Layer </h4>
<h5 id="2221-admin">2.2.2.1. Admin </h5>
<ul>
<li><strong>Authentication Service</strong>:
<ul>
<li>Sử dụng dịch vụ bên thứ ba(ZOO Auth) để xác thực login</li>
</ul>
</li>
<li><strong>Department Service</strong>:
<ul>
<li>Setting cờ trạng thái "突合審査対象変更"</li>
<li>Export CSV</li>
</ul>
</li>
<li><strong>Evaluation Service(月次審査チェック)</strong>:
<ul>
<li>Quản lý thông tin check tháng của cơ sở.</li>
<li>Tìm kiếm</li>
<li>Thực hiện upload file và run check</li>
<li>Export CSV</li>
</ul>
</li>
<li><strong>Benefit Service</strong>:
<ul>
<li>Danh sách cơ sở phúc lợi</li>
<li>Tìm kiếm</li>
<li>Tạo mới</li>
<li>Chỉnh sửa</li>
<li>Khởi tạo lại</li>
<li>Export CSV</li>
</ul>
</li>
<li><strong>Error Service</strong>:
<ul>
<li>Danh sách lỗi phán định</li>
<li>Tìm kiếm</li>
<li>Export CSV</li>
</ul>
</li>
</ul>
<h5 id="2222-user">2.2.2.2 User </h5>
<ul>
<li><strong>Authentication Service</strong>:
<ul>
<li>Sử dụng dịch vụ bên thứ ba(ZOO Auth) để xác thực login</li>
<li>Kiểm soát truy cập sử dụng tính năng dựa vào setting cờ trạng thái</li>
</ul>
</li>
<li><strong>Evaluation Service(月次審査チェック)</strong>:
<ul>
<li>Thực hiện check tháng của các cơ sở user đang liên kết</li>
<li>Thực hiện upload file và run check</li>
<li>Confirm lỗi phán định</li>
<li>Khởi tạo lại (事業所やり直し)</li>
<li>Kiểm tra (チェック)</li>
</ul>
</li>
</ul>
<h4 id="223-data-layer">2.2.3 Data Layer </h4>
<ul>
<li><strong>Database</strong>: Lưu trữ dữ liệu hệ thống</li>
<li><strong>File Storage</strong>: Lưu trữ tệp của hệ thống</li>
</ul>
<h4 id="224-external-systems">2.2.4 External Systems </h4>
<ul>
<li><strong>Email Service</strong>:
<ul>
<li>Gửi thông báo phát hiện lỗi đến người phụ trách cơ sở liên quan từ lần kiểm tra thứ 2 trở đi.</li>
<li>Sử dụng Amazon SES (Simple Email Service) để gửi email.</li>
</ul>
</li>
</ul>
<h3 id="23-sơ-đồ-chức-năng">2.3 Sơ đồ chức năng </h3>
<h4 id="231-chức-năng-quyền-admin">2.3.1 Chức năng quyền Admin </h4>
<div class="mermaid">graph TB
    subgraph "Presentation Layer"
        UI[Web UI]
    end

    subgraph "Business Logic Layer"
        Auth[ZOO Auth Auth Service]
        DepartmentManagement[Department Management Service]
        DepartmentExportCSV[Department ExportCSV Service]
        EvaluationManagement[Evaluation Management Service]
        EvaluationExportCSV[Evaluation ExportCSV Service]
        RunCheck[Upload and Run Check Service]
        BenefitManagement[Benefit Management Service]
        BenefitExportCSV[Benefit ExportCSV Service]
        ErrorManagement[Error Management Service]
        ErrorExportCSV[Error ExportCSV Service]
    end

    subgraph "Data Layer"
        DB[(Database)]
        FileStorage[File Storage]
    end

    subgraph "External Systems"
        Queue[Supervisor Service]
        EmailService[Email Service]
    end

    UI --&gt; Auth
    UI --&gt; DepartmentManagement
    UI --&gt; DepartmentExportCSV
    UI --&gt; EvaluationManagement
    UI --&gt; EvaluationExportCSV
    UI --&gt; BenefitManagement
    UI --&gt; BenefitExportCSV
    UI --&gt; ErrorManagement
    UI --&gt; ErrorExportCSV
    UI --&gt; RunCheck

    Auth --&gt; DB
    DepartmentManagement --&gt; DB
    DepartmentExportCSV --&gt; DB
    EvaluationManagement --&gt; DB
    EvaluationExportCSV --&gt; DB
    RunCheck --&gt; DB
    RunCheck --&gt; FileStorage
    RunCheck --&gt; EmailService
    RunCheck --&gt; Queue
    BenefitManagement --&gt; DB
    BenefitExportCSV --&gt; DB
    ErrorManagement --&gt; DB
    ErrorExportCSV --&gt; DB

</div><h4 id="232-chức-năng-quyền-người-dùng">2.3.2 Chức năng quyền người dùng </h4>
<div class="mermaid">graph TB
    subgraph "Presentation Layer"
        UI[Web UI]
    end

    subgraph "Business Logic Layer"
        Auth[ZOO Auth Auth Service]
        Evaluation[Evaluation Service]
        RunCheck[Upload and Run Check Service]
    end

    subgraph "Data Layer"
        DB[(Database)]
        FileStorage[File Storage]
    end

    subgraph "External Systems"
        Queue[Supervisor Service]
        EmailService[Email Service]
    end

    UI --&gt; Auth
    UI --&gt; Evaluation
    UI --&gt; RunCheck

    Auth --&gt; DB
    Evaluation --&gt; DB
    RunCheck --&gt; DB
    RunCheck --&gt; FileStorage
    RunCheck --&gt; EmailService
    RunCheck --&gt; Queue
</div><h2 id="3-kiến-trúc-cơ-sở-dữ-liệu">3. Kiến trúc cơ sở dữ liệu </h2>
<div class="mermaid">erDiagram
    departments ||--o{ facilities : "hasMany"
    facilities ||--o{ evaluations : "hasMany"
    evaluations ||--o{ evaluation_status_histories : "hasMany"
    evaluations ||--o| evaluation_benifit_histories : "hasOne"
    evaluation_benifits ||--o{ evaluation_benifit_histories : "hasMany"
    evaluation_benifit_histories ||--o{ evaluation_status_histories : "hasMany"
    evaluation_groups ||--|{ evaluation_group_facilities : "hasMany"
    evaluation_check_processes ||--o{ evaluation_files : "hasMany"
    evaluation_check_processes ||--o{ evaluation_errors : "hasMany"
    evaluation_check_processes ||--o{ evaluation_groups : "hasMany"
    evaluations ||--o{ evaluation_check_processes : "hasMany"

    departments {
        bigInt id PK
        varchar name
        bigInt updated_by
        bigInt created_by
        datetime created_at
        datetime updated_at
        bigInt organization_id
        varchar code
        bigInt number_layer
        datetime change_at
        datetime deleted_at
        varchar address
        varchar phone
        varchar fax
        varchar email
    }

    facilities {
        bigInt id PK
        varchar name
        varchar name_layer3
        bigInt departments_id FK
        varchar list_type_check
        bigInt updated_by
        bigInt created_by
        datetime created_at
        datetime updated_at
        bigInt organization_id
        varchar code
        bigInt number_layer
        datetime change_at
        datetime deleted_at
        tinyint is_active
        tinyint is_active_monthly_evaluation
        varchar address
        varchar phone
        varchar fax
        varchar email
        varchar hiiragi_code
        varchar office_code
    }

    evaluations {
        bigInt id PK
        varchar year_month
        bigInt facility_id FK
        tinyInt service_type
        bigInt created_by
        bigInt updated_by
        datetime created_at
        datetime updated_at
    }

    evaluation_status_histories {
        bigInt id PK
        bigInt evaluation_id FK
        tinyInt status
        bigInt created_by
        bigInt updated_by
        datetime created_at
        datetime updated_at
    }

    evaluation_files {
        bigInt id PK
        varchar year_month
        bigInt evaluation_check_process_id Fk
        varchar facility_code
        varchar file_name
        varchar file_path
        varchar file_type
        boolean is_admin_upload
        tinyInt upload_count
        bigInt created_by
        bigInt updated_by
        datetime created_at
        datetime updated_at
        datetime deleted_at
    }

    evaluation_errors {
        bigInt id PK
        bigInt evaluation_check_process_id FK
        bigInt parent_error_id FK
        varchar year_month
        bigInt facility_id FK
        tinyInt error_type
        varchar facility_code
        varchar facility_name
        varchar file_name
        varchar month
        varchar insurer_number
        varchar insured_number
        varchar planned_units_homecare
        varchar planned_units_facility
        varchar limited_managed_units
        varchar error_message
        varchar resolution_method
        tinyInt response
        tinyInt reason
        bigInt created_by
        bigInt updated_by
        datetime created_at
        datetime updated_at
    }

    evaluation_check_processes {
        bigInt id PK
        varchar year_month
        tinyInt status
        boolean is_checking
        bigInt job_id FK
        bigInt created_by
        bigInt updated_by
        datetime created_at
        datetime updated_at
    }

    evaluation_benifits {
        bigInt id PK
        varchar office_name
        varchar office_code
        bigInt created_by
        bigInt updated_by
        datetime created_at
        datetime updated_at
        datetime deleted_at
    }

    evaluation_benifit_histories {
        bigInt id PK
        varchar year_month
        bigInt evaluation_id FK
        bigInt evaluation_benifit_id FK
        bigInt created_by
        bigInt updated_by
        datetime created_at
        datetime updated_at
    }

    evaluation_groups {
        bigInt id PK
        bigInt evaluation_check_process_id FK
        varchar year_month
        bigInt created_by
        bigInt updated_by
        datetime created_at
        datetime updated_at
    }

    evaluation_group_facilities {
        bigInt id PK
        bigInt evaluation_group_id FK
        varchar facility_code
        bigInt created_by
        bigInt updated_by
        datetime created_at
        datetime updated_at
    }
</div><p>※ Ghi chú:</p>
<ul>
<li>PK: Primary Key</li>
<li>FK: Foreign Key</li>
<li>Các cột created_by, updated_by là user_id của người thao tác.</li>
<li>Các bảng có cột deleted_at sử dụng cơ chế Soft Delete của Laravel.</li>
</ul>
<h2 id="4-data-flow-データフロー">4. Data Flow (データフロー) </h2>
<h3 id="41-admin-chức-năng-đăng-nhập">4.1. [Admin] Chức năng đăng nhập </h3>
<div class="mermaid">sequenceDiagram
    participant U as User
    participant UI as Web UI
    participant L as Seikyu Check (SP)
    participant Z as ZOO Auth Auth Server (IdP)
    
    U-&gt;&gt;UI: Truy cập trang đăng nhập
    UI-&gt;&gt;L: Request /login/ZOO Auth
    L-&gt;&gt;Z: Redirect to ZOO Auth Authorization URL (client_id, redirect_uri, state)
    Z-&gt;&gt;U: Hiển thị màn hình xác thực ZOO Auth
    U-&gt;&gt;Z: Nhập tài khoản/mật khẩu ZOO Auth và đồng ý cấp quyền
    Z-&gt;&gt;L: Redirect về redirect_uri với code + state
    L-&gt;&gt;Z: Gửi request lấy access_token (POST /token)
    Z-&gt;&gt;L: Trả về access_token + id_token (JWT)
    L-&gt;&gt;Z: (Tuỳ chọn) Lấy thông tin người dùng (GET /userinfo)
    Z-&gt;&gt;L: Trả về thông tin người dùng (ZOO Auth ID, name, email, etc.)
    L-&gt;&gt;L: Kiểm tra tồn tại user (theo ZOO Auth_id)
    alt User tồn tại
        L-&gt;&gt;UI: Tạo session / token đăng nhập
        UI-&gt;&gt;U: Hiển thị MH quản lý trạng thái thanh toán
    else User không tồn tại
        L-&gt;&gt;UI: Redirect về màn hình login
        UI-&gt;&gt;U: Hiển thị thông báo "このアカウントが本システムにアクセスする権限がありません。"
    end
</div><h3 id="42-admin-chức-năng-setting-cờ-突合審査対象変更">4.2 [Admin] Chức năng setting cờ "突合審査対象変更" </h3>
<h4 id="421-màn-hình-quản-lý-chi-nhánh">4.2.1 Màn hình quản lý chi nhánh </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Department Screen
    participant API as DepartmentController
    participant S as DepartmentService
    participant DB as Database

    %% --- Danh sách chi nhánh ---
    U-&gt;&gt;UI: Nhấn tab (管理者)
    U-&gt;&gt;UI: Nhấn menu "支店管理"
    UI-&gt;&gt;API: Gửi request GET /admin/department
    API-&gt;&gt;S: Gọi hàm index()
    S-&gt;&gt;DB: Truy vấn danh sách chi nhánh và trạng thái cờ "突合審査対象変更" hiện tại
    DB-&gt;&gt;S: Trả kết quả danh sách
    S-&gt;&gt;API: Trả dữ liệu chi nhánh
    API-&gt;&gt;UI: Hiển thị danh sách chi nhánh và trạng thái ON/OFF cờ "突合審査対象変更"

    %% --- Cập nhật ON/OFF ---
    U-&gt;&gt;UI: Thay đổi cờ trạng thái check tháng của chi nhánh
    UI-&gt;&gt;API: Gửi request POST /admin/department/monthly-status { department_id, is_active_monthly_evaluation }
    API-&gt;&gt;S: Gọi hàm departmentMonthlyStatus($department_id, $flag)
    S-&gt;&gt;DB: Cập nhật giá trị cờ is_active_monthly_evaluation cho tất cả các cơ sở thuộc chi nhánh.
    DB-&gt;&gt;S: Trả kết quả cập nhật
    S-&gt;&gt;API: Trả kết quả cập nhật
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Cập nhật trạng thái hiển thị ON/OFF cờ "突合審査対象変更"
</div><h4 id="422-màn-hình-quản-lý-chi-tiết-chi-nhánh">4.2.2 Màn hình quản lý chi tiết chi nhánh </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Department Screen
    participant API1 as DepartmentController
    participant API2 as FacilityController
    participant S1 as DepartmentService
    participant S2 as FacilityService
    participant DB as Database

    %% --- Danh sách chi nhánh ---
    U-&gt;&gt;UI: Nhấn tab (管理者)
    U-&gt;&gt;UI: Nhấn menu "支店管理"
    UI-&gt;&gt;API1: Gửi request GET /admin/department
    API1-&gt;&gt;S1: Gọi hàm index()
    S1-&gt;&gt;DB: Truy vấn danh sách chi nhánh và trạng thái cờ "突合審査対象変更" hiện tại
    DB-&gt;&gt;S1: Trả kết quả
    S1-&gt;&gt;API1: Trả kết quả 
    API1-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị danh sách chi nhánh và trạng thái ON/OFF cờ "突合審査対象変更"

    %% --- Chi tiết chi nhánh ---
    U-&gt;&gt;UI: Nhấn "詳細"
    UI-&gt;&gt;API1: Gửi request GET /admin/department/{department_id}/edit
    API1-&gt;&gt;S1: Gọi hàm edit($department_id)
    S1-&gt;&gt;DB: Truy vấn tất cả cơ sở thuộc chi nhánh và trạng thái cờ "突合審査対象変更" hiện tại
    DB-&gt;&gt;S1: Trả kết quả danh sách
    S1-&gt;&gt;API1: Trả dữ liệu danh sách cơ sở thuộc chi nhánh
    API1-&gt;&gt;UI: Hiển thị danh sách cơ sở và trạng thái ON/OFF cờ "突合審査対象変更"

    %% --- Cập nhật ON/OFF ---
    U-&gt;&gt;UI: Thay đổi cờ trạng thái check tháng của cơ sở
    UI-&gt;&gt;API2: Gửi request POST /admin/facility/edit-status-active-monthly { facility_id, is_active_monthly_evaluation }
    API2-&gt;&gt;S2: Gọi hàm changeActiveStatusMonthly($facility_id, $flag)
    S2-&gt;&gt;DB: Cập nhật giá trị cờ is_active_monthly_evaluation cho cơ sở được chỉ định.
    DB-&gt;&gt;S2: Trả kết quả cập nhật
    S2-&gt;&gt;API2: Trả kết quả cập nhật
    API2-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Cập nhật trạng thái hiển thị ON/OFF cờ "突合審査対象変更"
</div><h3 id="43-admin-chức-năng-quản-lý-check-tháng">4.3 [Admin] Chức năng quản lý check tháng </h3>
<h4 id="431-chức-năng-quản-lý-trạng-thái-check-tháng">4.3.1 Chức năng quản lý trạng thái check tháng </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Evaluation Check Screen
    participant API as ManagementEvaluationController
    participant S as ManagementEvaluationService
    participant DB as Database

    %% --- Danh sách cơ sở check tháng ---
    U-&gt;&gt;UI: Chọn tháng (年月) và nhấn "Tìm kiếm"
    UI-&gt;&gt;API: Gửi request GET /admin/evaluations?setting_month=YYYYMM
    API-&gt;&gt;S: Gọi hàm index($request)
    S-&gt;&gt;DB: Truy vấn danh sách cơ sở thực hiện check tháng theo điều kiện tìm kiếm.
    DB-&gt;&gt;S: Trả về danh sách cơ sở đáp ứng điều kiện
    S-&gt;&gt;API: Trả về kết quả tổng hợp (thống kê số lượng theo trạng thái, dữ liệu cơ sở, điều kiện tìm kiếm)
    API-&gt;&gt;UI: Response kết quả
    UI-&gt;&gt;U: Hiển thị kết quả thống kê, kết quả check theo từng cơ sở
</div><h4 id="432-chức-năng-xuất-csv">4.3.2 Chức năng xuất CSV </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Monthly Check Screen
    participant API as ManagementEvaluationController
    participant S as ManagementEvaluationService
    participant CSV as CSV Export Utility
    participant DB as Database

    %% --- Xuất CSV ---
    U-&gt;&gt;UI: Nhấn nút "CSV出力"
    UI-&gt;&gt;API: Gửi request GET /admin/evaluation/export
    API-&gt;&gt;S: Gọi hàm export($request)
    S-&gt;&gt;DB: Truy vấn dữ liệu check tháng theo điều kiện tìm kiếm
    DB-&gt;&gt;S: Trả về danh sách dữ liệu phù hợp
    S-&gt;&gt;CSV: Gọi hàm download($data) để tạo file CSV
    CSV-&gt;&gt;S: Trả về đường dẫn hoặc stream của file CSV
    S-&gt;&gt;API: Trả kết quả file CSV
    API-&gt;&gt;UI: Trả response (Content-Disposition: attachment, filename="月次審査チェック_YYYYMMDD.csv")
    UI-&gt;&gt;U: Tự động tải file CSV về máy người dùng
</div><h4 id="433-chức-năng-upload-file-và-run-check">4.3.3 Chức năng upload file và run check </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Evaluation Check Screen
    participant API as CheckEvaluationController
    participant S as EvaluationService
    participant J as Supervisor Service
    participant DB as Database
    participant FS as File Storage (S3/Local)
    participant E as Email Service

    %% --- Upload File ---
    U-&gt;&gt;UI: Nhấn nút "アップロード"
    U-&gt;&gt;UI: Chọn file hoặc kéo thả file
    U-&gt;&gt;UI: Nhấn nút "チェック"
    UI-&gt;&gt;API: Gửi request POST /check-evaluation { file, setting_month }
    API-&gt;&gt;S: Gọi hàm checkFile($request)
    S-&gt;&gt;DB: Tạo dữ liệu tiến trình xử lý check vào bảng evaluation_check_processes(status=checking)
    S-&gt;&gt;FS: Lưu file vào Storage (S3 hoặc local)
    FS-&gt;&gt;S: Trả về path lưu file
    S-&gt;&gt;DB: Lưu thông tin file K upload và bảng evaluation_files
    S-&gt;&gt;J: Dispatch Job CheckMonthlyJob::dispatch($evaluationCheckProcessId)
    S-&gt;&gt;DB: Cập nhật id job cho tiến trình 
    DB-&gt;&gt;S: Trả về kết quả id tiến trình xử lý
    S-&gt;&gt;API: Trả kết quả id tiến trình xử lý
    API-&gt;&gt;UI: Response upload id tiến trình xử lý
    UI-&gt;&gt;U: Hiển thị pupup Run check "アップロードファイル"

    %% --- Run Check ---
    J-&gt;&gt;S: Gọi function checkFunction($evaluationCheckProcessId) để xử lý
    S-&gt;&gt;DB: Lấy dữ liệu tiến trình trong bảng evaluation_check_processes.
    DB-&gt;&gt;S: Trả dữ liệu tiến trình check.
    S-&gt;&gt;DB: Lấy dữ liệu file K upload của tiến trình check.
    DB-&gt;&gt;S: Trả dữ liệu file K của tiến trình check.
    S-&gt;&gt;S: Xử lý đọc và lấy thông tin trong file K
    S-&gt;&gt;DB: Cập nhật thêm thông tin dữ liệu file K upload vào bảng evaluation_files.
    S-&gt;&gt;DB: Lấy dữ liệu file M có trạng thái hoàn thành.
    DB-&gt;&gt;S: Trả dữ liệu file M ở trạng thái hoàn thành.
    S-&gt;&gt;DB: Lưu thông tin file M và bảng evaluation_files.
    S-&gt;&gt;S: Xử lý lọc dữ liệu file M.
    S-&gt;&gt;S: Xử lý lọc dữ liệu file K.
    S-&gt;&gt;S: Xử lý nhóm hoá.
    S-&gt;&gt;DB: Lưu thông tin nhóm hoá vào bảng evaluation_groups và evaluation_group_facilities
    S-&gt;&gt;S: Xử lý phán định lỗi cho nhóm đủ file.
    S-&gt;&gt;S: Xử lý phán định lỗi cũ, lỗi mới
    S-&gt;&gt;DB: Lưu lỗi và bảng evaluation_errors
    S-&gt;&gt;DB: Lưu trạng thái lỗi vào bảng evaluation_status_histories
    S-&gt;&gt;E: Gửi mail thông báo EvaluationErrorEvent::dispatch($group)
    S-&gt;&gt;S: Kiểm tra tất cả nhóm đang pending
    S-&gt;&gt;DB: Lưu trạng thái thành công cho nhóm vào bảng evaluation_status_histories
    S-&gt;&gt;DB: Cập nhật trạng thái tiến trình (status=done)

    %% --- Run Check trạng thái check ---
    U-&gt;&gt;UI: Tự động gọi kiểm tra trạng thái check
    UI-&gt;&gt;API: Gửi request GET /check-status-run-cron-evaluation { evaluationCheckProcessId }
    API-&gt;&gt;S: Gọi hàm checkStatusRunCronJob($request)
    S-&gt;&gt;DB: Lấy thông tin tiến trình
    DB-&gt;&gt;S: Trả thông tin tiến trình
    S-&gt;&gt;API: Trả thông tin tiến trình
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị hoàn tất quá trình check
</div><h3 id="44-admin-chức-năng-quản-lý-phúc-lợi">4.4 [Admin] Chức năng quản lý phúc lợi </h3>
<h4 id="441-chức-năng-quản-lý-trạng-thái-phúc-lợi">4.4.1 Chức năng quản lý trạng thái phúc lợi </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Benefit Check Screen
    participant API as ManagementEvaluationController
    participant S as ManagementEvaluationService
    participant DB as Database

    %% --- Danh sách cơ sở phúc lợi ---
    U-&gt;&gt;UI: Truy cập màn hình "給付管理取込管理画面​"
    UI-&gt;&gt;API: Gửi request GET /admin/evaluation-benefits?setting_month=YYYYMM
    API-&gt;&gt;S: Gọi hàm benefit($request)
    S-&gt;&gt;DB: Truy vấn danh sách cơ sở phúc lợi theo điều kiện tìm kiếm.
    DB-&gt;&gt;S: Trả về danh sách cơ sở đáp ứng điều kiện
    S-&gt;&gt;API: Trả về kết quả tổng hợp (dữ liệu phúc lợi, điều kiện tìm kiếm)
    API-&gt;&gt;UI: Response kết quả
    UI-&gt;&gt;U: Hiển thị MH cơ sở phúc lợi
</div><h4 id="442-chức-năng-xuất-csv">4.4.2 Chức năng xuất CSV </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Benefit Check Screen
    participant API as ManagementEvaluationController
    participant S as ManagementEvaluationService
    participant CSV as CSV Export Utility
    participant DB as Database

    %% --- Xuất CSV ---
    U-&gt;&gt;UI: Nhấn nút "CSV出力"
    UI-&gt;&gt;API: Gửi request GET /admin/evaluation-benefit/export
    API-&gt;&gt;S: Gọi hàm exportBenefit($request)
    S-&gt;&gt;DB: Truy vấn dữ liệu phúc lợi theo điều kiện tìm kiếm
    DB-&gt;&gt;S: Trả về danh sách dữ liệu phù hợp
    S-&gt;&gt;CSV: Gọi hàm download($data) để tạo file CSV
    CSV-&gt;&gt;S: Trả về đường dẫn hoặc stream của file CSV
    S-&gt;&gt;API: Trả kết quả file CSV
    API-&gt;&gt;UI: Trả response (Content-Disposition: attachment, filename="給付管理取込管理画面リスト_YYYYMM.csv")
    UI-&gt;&gt;U: Tự động tải file CSV về máy người dùng
</div><h4 id="443-chức-năng-tạo-mới">4.4.3 Chức năng tạo mới </h4>
<div class="mermaid">sequenceDiagram
participant U as Web UI
    participant UI as Benefit Check Screen
    participant API as ManagementEvaluationController
    participant S as ManagementEvaluationService
    participant DB as Database

    %% --- Tạo mới ---
    U-&gt;&gt;UI: Nhấn button "新規追加"
    U-&gt;&gt;UI: Nhập dữ liệu
    U-&gt;&gt;UI: Nhấn nút "保存"
    UI-&gt;&gt;API: Gửi request POST /admin/evaluation-benefit { formData }
    API-&gt;&gt;S: Gọi hàm storeEvaluationBenefit($request)
    S-&gt;&gt;DB: Thực hiện INSERT dữ liệu mới vào bảng evaluation_benifits
    DB-&gt;&gt;S: Trả kết quả
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị dữ liệu mới tạo lên màn hình
</div><h4 id="444-chức-năng-chỉnh-sửa">4.4.4 Chức năng chỉnh sửa </h4>
<div class="mermaid">sequenceDiagram
participant U as Web UI
    participant UI as Benefit Check Screen
    participant API as ManagementEvaluationController
    participant S as ManagementEvaluationService
    participant DB as Database

    %% --- Danh sách cơ sở phúc lợi ---
    U-&gt;&gt;UI: Nhấn nút "更新"
    UI-&gt;&gt;API: Gửi request GET /admin/evaluation-benefit { formData }
    API-&gt;&gt;S: Gọi hàm detail($request)
    S-&gt;&gt;DB: Truy vấn dữ liệu phúc lợi
    DB-&gt;&gt;S: Trả kết quả
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị dữ liệu lên popup chỉnh sửa

    %% --- Chỉnh sửa ---
    U-&gt;&gt;UI: Cập nhật dữ liệu
    U-&gt;&gt;UI: Nhấn nút "保存"
    UI-&gt;&gt;API: Gửi request PUT /admin/evaluation-benefit { formData }
    API-&gt;&gt;S: Gọi hàm updateEvaluationBenefit($request)
    S-&gt;&gt;DB: Thực hiện UPDATE dữ liệu vào bảng evaluation_benifits
    DB-&gt;&gt;S: Trả kết quả
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị dữ liệu đã được update lên màn hình
</div><h3 id="445-chức-năng-khởi-tạo-lại">4.4.5 Chức năng "Khởi tạo lại" </h3>
<div class="mermaid">sequenceDiagram
participant U as Web UI
    participant UI as Benefit Check Screen
    participant API as ManagementEvaluationController
    participant S as ManagementEvaluationService
    participant DB as Database

    %% --- Khởi tạo ---
    U-&gt;&gt;UI: Nhấn nút "初期化"
    UI-&gt;&gt;API: Gửi request POST /admin/evaluation-benefit/redo { formData }
    API-&gt;&gt;S: Gọi hàm redoEvaluationBenefit($request)
    S-&gt;&gt;DB: Tạo dữ liệu với trạng thái "khởi tạo lại" trong bảng evaluation_status_histories
    S-&gt;&gt;DB: Xoá dữ liệu file upload trong bảng evaluation_files
    DB-&gt;&gt;S: Trả kết quả
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị dữ liệu với trạng thái mới lên màn hình
</div><h3 id="45-admin-chức-năng-quản-lý-lỗi">4.5 [Admin] Chức năng quản lý lỗi </h3>
<h4 id="451-chức-năng-quản-lý-danh-sách-lỗi">4.5.1 Chức năng quản lý danh sách lỗi </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Error Check Screen
    participant API as ManagementEvaluationController
    participant S as ManagementEvaluationService
    participant DB as Database

    %% --- Danh sách lỗi phán định ---
    U-&gt;&gt;UI: Truy cập màn hình "エラー一覧画面"
    UI-&gt;&gt;API: Gửi request GET /admin/evaluation-errors?setting_month=YYYYMM
    API-&gt;&gt;S: Gọi hàm errors($request)
    S-&gt;&gt;DB: Truy vấn danh sách lỗi phán định theo điều kiện tìm kiếm.
    DB-&gt;&gt;S: Trả kết quả
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị kết quả danh sách lỗi
</div><h4 id="452-chức-năng-xuất-csv">4.5.2 Chức năng xuất CSV </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Error Check Screen
    participant API as ManagementEvaluationController
    participant S as ManagementEvaluationService
    participant CSV as CSV Export Utility
    participant DB as Database

    %% --- Xuất CSV ---
    U-&gt;&gt;UI: Nhấn nút "CSV出力"
    UI-&gt;&gt;API: Gửi request GET /admin/evaluation-errors/export
    API-&gt;&gt;S: Gọi hàm exportError($request)
    S-&gt;&gt;DB: Truy vấn dữ liệu lỗi theo điều kiện tìm kiếm
    DB-&gt;&gt;S: Trả về danh sách dữ liệu phù hợp
    S-&gt;&gt;CSV: Gọi hàm download($data) để tạo file CSV
    CSV-&gt;&gt;S: Trả về đường dẫn hoặc stream của file CSV
    S-&gt;&gt;API: Trả kết quả file CSV
    API-&gt;&gt;UI: Trả response (Content-Disposition: attachment, filename="エラー一覧_YYYYMM.csv")
    UI-&gt;&gt;U: Tự động tải file CSV về máy người dùng
</div><h3 id="46--user-chức-năng-đăng-nhập">4.6.  [User] Chức năng đăng nhập </h3>
<div class="mermaid">sequenceDiagram
    participant U as User
    participant UI as Web UI
    participant L as Seikyu Check (SP)
    participant Z as ZOO Auth Auth Server (IdP)

    U-&gt;&gt;UI: Truy cập trang đăng nhập
    UI-&gt;&gt;L: Request /login/ZOO Auth
    L-&gt;&gt;Z: Redirect to ZOO Auth Authorization URL (client_id, redirect_uri, state)
    Z-&gt;&gt;U: Hiển thị màn hình xác thực ZOO Auth
    U-&gt;&gt;Z: Nhập tài khoản/mật khẩu ZOO Auth và đồng ý cấp quyền
    Z-&gt;&gt;L: Redirect về redirect_uri với code + state
    L-&gt;&gt;Z: Gửi request lấy access_token (POST /token)
    Z-&gt;&gt;L: Trả về access_token + id_token (JWT)
    L-&gt;&gt;Z: (Tuỳ chọn) Lấy thông tin người dùng (GET /userinfo)
    Z-&gt;&gt;L: Trả về thông tin người dùng (ZOO Auth ID, name, email, etc.)
    L-&gt;&gt;L: Kiểm tra tồn tại user (theo ZOO Auth_id)
    alt User tồn tại
        L-&gt;&gt;UI: Tạo session / token đăng nhập
        UI-&gt;&gt;U: Hiển thị màn hình Dashboard
    else User không tồn tại
        L-&gt;&gt;UI: Redirect về màn hình login
        UI-&gt;&gt;U: Hiển thị thông báo "このアカウントが本システムにアクセスする権限がありません。"
    end
</div><h3 id="47-user-chức-năng-check-tháng">4.7 [User] Chức năng check tháng </h3>
<h4 id="471-thực-hiện-check-tháng-của-các-cơ-sở-user-đang-liên-kết">4.7.1 Thực hiện check tháng của các cơ sở user đang liên kết </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Evaluation Check Screen
    participant API as EvaluationController
    participant S as FacilityEvaluationService
    participant DB as Database

    %% --- Lỗi phán định ---
    U-&gt;&gt;UI: Chọn chi nhánh
    U-&gt;&gt;UI: Chọn cơ sở
    U-&gt;&gt;UI: Chọn tháng (年月) và nhấn "Tìm kiếm"
    UI-&gt;&gt;API: Gửi request GET /evaluation?setting_month=YYYYMM
    API-&gt;&gt;S: Gọi hàm index($request)
    S-&gt;&gt;DB: Truy vấn dữ liệu check tháng
    DB-&gt;&gt;S: Trả dữ liệu check tháng
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị kết quả check tháng
</div><h4 id="472-confirm-lỗi-phán-định">4.7.2 Confirm lỗi phán định </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Evaluation Check Screen
    participant API as EvaluationController
    participant S as FacilityEvaluationService
    participant DB as Database

    %% --- Lỗi phán định ---
    U-&gt;&gt;UI: Chọn chi nhánh
    U-&gt;&gt;UI: Chọn cơ sở
    U-&gt;&gt;UI: Chọn tháng (年月) và nhấn "Tìm kiếm"
    UI-&gt;&gt;API: Gửi request GET /evaluation?setting_month=YYYYMM
    API-&gt;&gt;S: Gọi hàm index($request)
    S-&gt;&gt;DB: Truy vấn dữ liệu lỗi phán định
    DB-&gt;&gt;S: Trả dữ liệu
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị danh sách lỗi phán định

    %% --- Confirm lỗi ---
    U-&gt;&gt;UI: Chọn "対応" hoặc "理由"
    UI-&gt;&gt;API: Gửi request POST /save-evaluation-action
    API-&gt;&gt;S: Gọi hàm saveActionReason($request)
    S-&gt;&gt;DB: Cập nhật dữ liệu lỗi mục "response" hoặc "reason" vào bảng evaluation_errors
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị kết quả confirm lỗi lên màn hình
</div><h4 id="473-thực-hiện-upload-file-và-run-check">4.7.3 Thực hiện upload file và run check </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Evaluation Check Screen
    participant API as CheckEvaluationController
    participant S as EvaluationService
    participant J as Supervisor Service
    participant DB as Database
    participant FS as File Storage (S3/Local)
    participant E as Email Service

    %% --- Upload File K ---
    U-&gt;&gt;UI: Nhấn nút "アップロード"
    U-&gt;&gt;UI: Chọn file hoặc kéo thả file
    U-&gt;&gt;UI: Nhấn nút "チェック"
    UI-&gt;&gt;API: Gửi request POST /check-evaluation-facility { file, setting_month }
    API-&gt;&gt;S: Gọi hàm checkFileFacility($request)
    S-&gt;&gt;DB: Tạo dữ liệu tiến trình xử lý check vào bảng evaluation_check_processes(status=checking)
    S-&gt;&gt;FS: Lưu file vào Storage (S3 hoặc local)
    FS-&gt;&gt;S: Trả về path lưu file
    S-&gt;&gt;DB: Lưu thông tin file K upload và bảng evaluation_files
    S-&gt;&gt;J: Dispatch Job CheckEvaluationFacilityJob::dispatch($month)
    S-&gt;&gt;DB: Cập nhật id job cho tiến trình 
    DB-&gt;&gt;S: Trả về kết quả id tiến trình xử lý
    S-&gt;&gt;API: Trả kết quả id tiến trình xử lý
    API-&gt;&gt;UI: Response upload id tiến trình xử lý
    UI-&gt;&gt;U: Hiển thị pupup Run check "アップロードファイル"

    %% --- Run Check ---
    J-&gt;&gt;S: Gọi function checkFunctionFacility($evaluationCheckProcessId) để xử lý
    S-&gt;&gt;DB: Lấy dữ liệu tiến trình trong bảng evaluation_check_processes.
    DB-&gt;&gt;S: Trả dữ liệu tiến trình check.
    S-&gt;&gt;DB: Lấy dữ liệu file K upload của tiến trình check.
    DB-&gt;&gt;S: Trả dữ liệu file K của tiến trình check.
    S-&gt;&gt;DB: Lấy dữ liệu file M có trạng thái hoàn thành.
    DB-&gt;&gt;S: Trả dữ liệu file M ở trạng thái hoàn thành.
    S-&gt;&gt;DB: Lưu thông tin file M và bảng evaluation_files.
    S-&gt;&gt;S: Xử lý lọc dữ liệu file M.
    S-&gt;&gt;S: Xử lý lọc dữ liệu file K.
    S-&gt;&gt;S: Xử lý nhóm hoá.
    S-&gt;&gt;DB: Lưu thông tin nhóm hoá vào bảng evaluation_groups và evaluation_group_facilities
    S-&gt;&gt;S: Xử lý phán định lỗi cho nhóm đủ file.
    S-&gt;&gt;S: Xử lý phán định lỗi cũ, lỗi mới
    S-&gt;&gt;DB: Lưu lỗi và bảng evaluation_errors
    S-&gt;&gt;DB: Lưu trạng thái lỗi vào bảng evaluation_status_histories
    S-&gt;&gt;E: Gửi mail thông báo EvaluationErrorEvent::dispatch($group)
    S-&gt;&gt;S: Kiểm tra tất cả nhóm đang pending
    S-&gt;&gt;DB: Lưu trạng thái thành công cho nhóm vào bảng evaluation_status_histories
    S-&gt;&gt;DB: Cập nhật trạng thái tiến trình (status=done)

    %% --- Kiểm tra trạng thái check ---
    U-&gt;&gt;UI: Tự động gọi kiểm tra trạng thái check
    UI-&gt;&gt;API: Gửi request GET /check-status-run-cron-evaluation { evaluationCheckProcessId }
    API-&gt;&gt;S: Gọi hàm checkStatusRunCronJob($request)
    S-&gt;&gt;DB: Lấy thông tin tiến trình
    DB-&gt;&gt;S: Trả thông tin tiến trình
    S-&gt;&gt;API: Trả thông tin tiến trình
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị hoàn tất quá trình check
</div><h4 id="474-khởi-tạo-lại-事業所やり直し">4.7.4 Khởi tạo lại (事業所やり直し) </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Evaluation Check Screen
    participant API as EvaluationController
    participant S as FacilityEvaluationService
    participant DB as Database

    %% --- Lỗi phán định ---
    U-&gt;&gt;UI: Chọn chi nhánh
    U-&gt;&gt;UI: Chọn cơ sở
    U-&gt;&gt;UI: Chọn tháng (年月) và nhấn "Tìm kiếm"
    UI-&gt;&gt;API: Gửi request GET /evaluation?setting_month=YYYYMM
    API-&gt;&gt;S: Gọi hàm index($request)
    S-&gt;&gt;DB: Truy vấn dữ liệu lỗi phán định
    DB-&gt;&gt;S: Trả dữ liệu
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị MH lỗi phán định

    %% --- Khởi tạo ---
    U-&gt;&gt;UI: Chọn "事業所やり直し"
    UI-&gt;&gt;API: Gửi request POST /handle-evaluation-actions
    API-&gt;&gt;S: Gọi hàm handleRetryAction($request)
    S-&gt;&gt;DB: Tạo dữ liệu trang thái mới "khởi tạo lại" vào bảng evaluation_status_histories
    S-&gt;&gt;DB: Xoá dữ liệu file upload trong bảng evaluation_files
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị MH trạng thái "khởi tạo lại"
</div><h4 id="475-kiểm-tra-チェック">4.7.5 Kiểm tra (チェック) </h4>
<div class="mermaid">sequenceDiagram
    participant U as Web UI
    participant UI as Evaluation Check Screen
    participant API as EvaluationController
    participant S as FacilityEvaluationService
    participant DB as Database

    %% --- Lỗi phán định ---
    U-&gt;&gt;UI: Chọn chi nhánh
    U-&gt;&gt;UI: Chọn cơ sở
    U-&gt;&gt;UI: Chọn tháng (年月) và nhấn "Tìm kiếm"
    UI-&gt;&gt;API: Gửi request GET /evaluation?setting_month=YYYYMM
    API-&gt;&gt;S: Gọi hàm index($request)
    S-&gt;&gt;DB: Truy vấn dữ liệu lỗi phán định
    DB-&gt;&gt;S: Trả dữ liệu
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị MH lỗi phán định

    %% --- Kiểm tra ---
    U-&gt;&gt;UI: Chọn "チェック"
    UI-&gt;&gt;API: Gửi request POST /handle-evaluation-actions
    API-&gt;&gt;S: Gọi hàm handleCheckAction($request)
    S-&gt;&gt;DB: Tạo dữ liệu trang thái mới "pending" vào bảng evaluation_status_histories
    S-&gt;&gt;DB: Lấy dữ liệu nhóm cơ sở liên quan
    DB-&gt;&gt;S: Trả dữ liệu nhóm cơ sở liên quan
    S-&gt;&gt;S:: Kiểm tra trạng thái cơ sở trong nhóm
    alt Tất cả đều ở trạng thái "pending"
        S-&gt;&gt;DB: Tạo dữ liệu trang thái "success" cho cơ sở cùng nhóm vào bảng evaluation_status_histories
    end
    S-&gt;&gt;API: Trả kết quả
    API-&gt;&gt;UI: Trả response
    UI-&gt;&gt;U: Hiển thị MH theo trạng thái
    alt Trạng thái "pending"
        UI-&gt;&gt;U: Hiển thị MH trạng thái "pending"
    else Trạng thái "success"
        UI-&gt;&gt;U: Hiển thị MH trạng thái "success"
    end
</div><h2 id="5-bảo-mật-và-hiệu-suất">5. Bảo mật và Hiệu suất </h2>
<h3 id="51-bảo-mật">5.1 Bảo mật </h3>
<ul>
<li>Xác thực OIDC Authorization Code (khuyến nghị kèm PKCE) với ZOO Auth</li>
<li>Session server-side; CSRF token cho form; CORS whitelist theo môi trường</li>
</ul>
<h3 id="52-theo-dõi-kiểm-toán">5.2 Theo dõi Kiểm toán: </h3>
<p>① Nhật ký Vận hành = Tên Người dùng Đăng nhập, Ngày, Giờ và Giây Xử lý, Màn hình Vận hành<br>
② Lưu trữ Kết quả Kiểm tra = 3 Năm</p>
<h3 id="53-hiệu-suất">5.3 Hiệu suất </h3>
<p>① Hỗ trợ hơn 100MB<br>
② Khả năng Xử lý Song song = Dự kiến sử dụng đồng thời cho khoảng 10 cơ sở</p>
<ul>
<li>Bảo mật: Quét vi-rút, quản lý PII</li>
<li>Xử lý Ngoại lệ: Không giới hạn thời gian chờ</li>
<li>Khả năng mở rộng: Khả năng thêm quy tắc và thay đổi định dạng</li>
</ul>
<h2 id="6-phiên-bản--quản-lý-thay-đổi">6. Phiên bản &amp; quản lý thay đổi </h2>
<table>
<thead>
<tr>
<th>Phiên bản</th>
<th>Ngày cập nhật</th>
<th>Người cập nhật</th>
<th>Nội dung thay đổi</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.0.0</td>
<td>2025/09/30</td>
<td>Relipa</td>
<td>Tạo mới tài liệu</td>
</tr>
</tbody>
</table>

      </div>
      
      
    
    
    <script type="module">
// TODO: If ZenUML gets integrated into mermaid in the future,
//      we can remove the following lines.


var MERMAID_CONFIG = ({"startOnLoad":false});
if (typeof MERMAID_CONFIG !== 'undefined') {
  MERMAID_CONFIG.startOnLoad = false
  MERMAID_CONFIG.cloneCssStyles = false
  MERMAID_CONFIG.theme = "default"
}

mermaid.initialize(MERMAID_CONFIG || {})
if (typeof(window['Reveal']) !== 'undefined') {
  function mermaidRevealHelper(event) {
    var currentSlide = event.currentSlide
    var diagrams = currentSlide.querySelectorAll('.mermaid')
    for (var i = 0; i < diagrams.length; i++) {
      var diagram = diagrams[i]
      if (!diagram.hasAttribute('data-processed')) {
        mermaid.init(null, diagram, ()=> {
          Reveal.slide(event.indexh, event.indexv)
        })
      }
    }
  }
  Reveal.addEventListener('slidetransitionend', mermaidRevealHelper)
  Reveal.addEventListener('ready', mermaidRevealHelper)
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
} else {
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
}
</script>
    
    
    
  
    </body></html>